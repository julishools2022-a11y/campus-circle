<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Sell an Item | Campus Circle</title>
                <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
                    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
                        <style>
                                :root { --primary: #2563eb; --dark: #0c1a32; --bg: #f1f1f2; }
                                        body { font-family: 'Roboto', sans-serif; margin: 0; background: var(--bg); padding-bottom: 50px; }
                                                
                                                        header { background: var(--dark); color: white; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 100; }
                                                                .container { max-width: 500px; margin: 20px auto; padding: 0 15px; }
                                                                        
                                                                                .form-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
                                                                                        
                                                                                                label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: #475569; }
                                                                                                        input, textarea, select { 
                                                                                                                    width: 100%; padding: 12px; margin-bottom: 20px; 
                                                                                                                                border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; 
                                                                                                                                        }

                                                                                                                                                .image-picker {
                                                                                                                                                            border: 2px dashed #cbd5e1;
                                                                                                                                                                        padding: 30px;
                                                                                                                                                                                    text-align: center;
                                                                                                                                                                                                border-radius: 10px;
                                                                                                                                                                                                            cursor: pointer;
                                                                                                                                                                                                                        margin-bottom: 20px;
                                                                                                                                                                                                                                }

                                                                                                                                                                                                                                        #preview-img { width: 100%; max-height: 200px; object-fit: contain; display: none; margin-bottom: 10px; }

                                                                                                                                                                                                                                                .btn-post { 
                                                                                                                                                                                                                                                            width: 100%; padding: 16px; background: var(--primary); 
                                                                                                                                                                                                                                                                        color: white; border: none; border-radius: 8px; 
                                                                                                                                                                                                                                                                                    font-weight: 700; font-size: 16px; cursor: pointer;
                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                </style>
                                                                                                                                                                                                                                                                                                </head>
                                                                                                                                                                                                                                                                                                <body>

                                                                                                                                                                                                                                                                                                <header>
                                                                                                                                                                                                                                                                                                    <h2 style="margin:0;">Post New Ad</h2>
                                                                                                                                                                                                                                                                                                    </header>

                                                                                                                                                                                                                                                                                                    <div class="container">
                                                                                                                                                                                                                                                                                                        <div class="form-card">
                                                                                                                                                                                                                                                                                                                <form id="listing-form">
                                                                                                                                                                                                                                                                                                                            <label>Product Photo</label>
                                                                                                                                                                                                                                                                                                                                        <div class="image-picker" onclick="document.getElementById('file-input').click()">
                                                                                                                                                                                                                                                                                                                                                        <img id="preview-img" src="">
                                                                                                                                                                                                                                                                                                                                                                        <div id="placeholder-text">ðŸ“¸ Tap to upload image</div>
                                                                                                                                                                                                                                                                                                                                                                                        <input type="file" id="file-input" accept="image/*" style="display:none" onchange="showPreview(event)">
                                                                                                                                                                                                                                                                                                                                                                                                    </div>

                                                                                                                                                                                                                                                                                                                                                                                                                <label>Item Name</label>
                                                                                                                                                                                                                                                                                                                                                                                                                            <input type="text" id="title" placeholder="e.g. iPhone 12 Pro" required>

                                                                                                                                                                                                                                                                                                                                                                                                                                        <label>WhatsApp Number</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                    <input type="tel" id="whatsapp" placeholder="e.g. 08012345678" required>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                <label>Price (â‚¦)</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <input type="number" id="price" placeholder="Price" required>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <label>Condition</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <select id="condition">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <option value="New">Brand New</option>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <option value="Used">Used</option>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <option value="Refurbished">Refurbished</option>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </select>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <label>Description</label>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <textarea id="description" rows="3" placeholder="Tell buyers more..."></textarea>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <button type="submit" class="btn-post" id="submit-btn">PUBLISH LISTING</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </form>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <p id="status" style="text-align:center; margin-top:15px; font-size:14px;"></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const supabaseUrl = 'https://nijjgpgxdhsrtftuqcoy.supabase.co';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pampncGd4ZGhzcnRmdHVxY295Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NTM1OTAsImV4cCI6MjA4MzUyOTU5MH0.v0pcYyNBjD_FeBVJCJHICEvbLwP1Q2Hjp08Jo_5ii3g'; 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        function showPreview(event) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const file = event.target.files[0];
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (file) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const reader = new FileReader();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                reader.onload = (e) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const img = document.getElementById('preview-img');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                img.src = e.target.result;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                img.style.display = 'block';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                document.getElementById('placeholder-text').style.display = 'none';
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        reader.readAsDataURL(file);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        document.getElementById('listing-form').onsubmit = async (e) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                e.preventDefault();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const btn = document.getElementById('submit-btn');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const status = document.getElementById('status');
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const file = document.getElementById('file-input').files[0];

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                btn.disabled = true;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status.textContent = "Uploading listing...";

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                try {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            const { data: { user } } = await _supabase.auth.getUser();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        let imageUrl = null;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    // 1. Upload Image to Storage Bucket 'listing-images'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (file) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const fileName = `${Date.now()}-${file.name}`;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                const { data: uploadData, error: uploadError } = await _supabase.storage
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    .from('listing-images')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        .upload(fileName, file);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (uploadError) throw uploadError;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const { data: urlData } = _supabase.storage
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            .from('listing-images')
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                .getPublicUrl(fileName);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                imageUrl = urlData.publicUrl;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        // 2. Save Data to Database
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    const { error: dbError } = await _supabase.from('listings').insert([{
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    name: document.getElementById('title').value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    price: parseInt(document.getElementById('price').value),
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    seller_phone: document.getElementById('whatsapp').value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    condition: document.getElementById('condition').value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    description: document.getElementById('description').value,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    image_url: imageUrl,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    user_id: user.id,
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    seller_email: user.email
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }]);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (dbError) throw dbError;

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        status.style.color = "green";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    status.textContent = "Success! Redirecting...";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                setTimeout(() => window.location.href = 'marketplace.html', 1500);

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        } catch (err) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    status.style.color = "red";
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                status.textContent = "Error: " + err.message;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            btn.disabled = false;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        };
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </script>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </body>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </html>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        