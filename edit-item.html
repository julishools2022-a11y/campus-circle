<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit My Listing | Campus Circle</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #2563eb; --dark: #0c1a32; --bg: #f8fafc; }
        body { font-family: 'Roboto', sans-serif; margin: 0; background: var(--bg); padding: 20px; }
        header { background: var(--dark); color: white; padding: 15px; border-radius: 8px 8px 0 0; text-align: center; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 25px; border-radius: 0 0 8px 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; }
        input, textarea, select { width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #e2e8f0; border-radius: 8px; font-size: 16px; }
        .btn-update { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; }
        .loading-overlay { text-align: center; padding: 20px; color: var(--primary); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <header><h2>Edit Your Item</h2></header>
    <div id="loading" class="loading-overlay">Fetching item details...</div>
    
    <form id="edit-form" style="display: none;">
        <label>Item Name</label>
        <input type="text" id="title" required>

        <label>Price (â‚¦)</label>
        <input type="number" id="price" required>

        <label>WhatsApp Number</label>
        <input type="tel" id="whatsapp" required>

        <label>Description</label>
        <textarea id="description" rows="4"></textarea>

        <button type="submit" class="btn-update" id="submit-btn">SAVE CHANGES</button>
    </form>
    <p id="status" style="text-align:center; margin-top:15px;"></p>
</div>

<script>
    const supabaseUrl = 'https://nijjgpgxdhsrtftuqcoy.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5pampncGd4ZGhzcnRmdHVxY295Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NTM1OTAsImV4cCI6MjA4MzUyOTU5MH0.v0pcYyNBjD_FeBVJCJHICEvbLwP1Q2Hjp08Jo_5ii3g'; 
    const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // 1. Get the ID from the URL
    const params = new URLSearchParams(window.location.search);
    const itemId = params.get('id');

   <!-- async function fetchExistingData() {
        if (!itemId) return window.location.href = 'profile.html'; -->

        const { data: item, error } = await _supabase
            .from('listings')
            .select('*')
            .eq('id', itemId)
            .single();

        if (item) {
            // Check if current user owns this item
            const { data: { user } } = await _supabase.auth.getUser();
            if (item.user_id !== user.id) {
                alert("You don't have permission to edit this item.");
                window.location.href = 'profile.html';
                return;
            }

            // Fill form
            document.getElementById('title').value = item.name;
            document.getElementById('price').value = item.price;
            document.getElementById('whatsapp').value = item.seller_phone;
            document.getElementById('description').value = item.description;
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('edit-form').style.display = 'block';
        }
    }

    document.getElementById('edit-form').onsubmit = async (e) => {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        const status = document.getElementById('status');
        
        btn.disabled = true;
        status.textContent = "Updating listing...";

        const { error } = await _supabase
            .from('listings')
            .update({
                name: document.getElementById('title').value,
                price: parseInt(document.getElementById('price').value),
                seller_phone: document.getElementById('whatsapp').value,
                description: document.getElementById('description').value
            })
            .eq('id', itemId);

        if (!error) {
            status.style.color = "green";
            status.textContent = "Successfully updated!";
            setTimeout(() => window.location.href = 'profile.html', 1500);
        } else {
            status.style.color = "red";
            status.textContent = "Update failed: " + error.message;
            btn.disabled = false;
        }
    };

    fetchExistingData();
</script>
</body>
</html>
